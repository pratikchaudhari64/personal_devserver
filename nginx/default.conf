upstream notion_app_upstream {
    server notion_app:5000; # 'notion_app' is the service name in docker-compose.yml
}

server {
    listen 80; # Nginx listens on port 80 inside its container
    server_name localhost;

    # Root location for serving default Nginx page or static files
    location / {
        root /usr/share/nginx/html;
        index index.html index.htm;
        try_files $uri $uri/ =404; # Attempts to serve static files or return 404
    }

    # Location for the Notion application (FastAPI)
    # Accessible via http://localhost:8000/notionapp/
    location /notionapp/ {
        proxy_pass http://notion_app_upstream/; # Proxies to the Notion app, stripping /notionapp/ prefix
        proxy_set_header Host $host; # Preserve the original Host header
        proxy_set_header X-Real-IP $remote_addr; # Pass the client's real IP address
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; # Append client's IP to X-Forwarded-For
        proxy_set_header X-Forwarded-Proto $scheme; # Indicate the original protocol (http/https)
    }

    # Optional: Nginx health check endpoint
    location /nginx_health {
        return 200 "Nginx is healthy\n"; # Returns a simple "Nginx is healthy" message
        add_header Content-Type text/plain;
    }

    # Custom error pages
    error_page 500 502 503 504 /50x.html;
    location = /50x.html {
        root /usr/share/nginx/html;
    }
}